<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Dynamic number of threads in celery - Almadih&#x27;s Blog</title><meta name="gridsome:hash" content="33cba4920c19c25c8a4390379f4aca5e62df75b6"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Almadih&#x27;s Personal Blog"><meta data-vue-tag="ssr" name="description" content="I guess this a followup to the previous post, where i talked about celery and some.."><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/blog/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/blog/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/blog/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/blog/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/blog/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/blog/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/blog/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/blog/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/blog/assets/css/0.styles.ca01b616.css" as="style"><link rel="preload" href="/blog/assets/js/app.344265fc.js" as="script"><link rel="preload" href="/blog/assets/js/page--src--templates--post-vue.aca2b486.js" as="script"><link rel="prefetch" href="/blog/assets/js/page--node-modules--gridsome--app--pages--404-vue.cc6408d5.js"><link rel="prefetch" href="/blog/assets/js/page--src--pages--index-vue.62fddcfd.js"><link rel="prefetch" href="/blog/assets/js/page--src--templates--tag-vue.24c7993e.js"><link rel="stylesheet" href="/blog/assets/css/0.styles.ca01b616.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <script>
      // Add dark / light detection that runs before Vue.js load. Borrowed from overreacted.io
      (function() {
        window.__onThemeChange = function() {};
        function setTheme(newTheme) {
          window.__theme = newTheme;
          preferredTheme = newTheme;
          document.body.setAttribute('data-theme', newTheme);
          window.__onThemeChange(newTheme);
        }

        var preferredTheme;
        try {
          preferredTheme = localStorage.getItem('theme');
        } catch (err) { }

        window.__setPreferredTheme = function(newTheme) {
          setTheme(newTheme);
          try {
            localStorage.setItem('theme', newTheme);
          } catch (err) {}
        }

        var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkQuery.addListener(function(e) {
          window.__setPreferredTheme(e.matches ? 'dark' : 'light')
        });

        setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
      })();
    </script>

    <div id="app" data-server-rendered="true"><header class="header"><div class="header__left"><a href="/blog/" class="logo active"><span class="logo__text"> ← Almadih's Blog </span></a></div><div class="header__right"><button role="button" aria-label="Toggle dark/light" class="toggle-theme"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">
      Dynamic number of threads in celery
    </h1><div class="post-meta">
   Posted 2. August 2022.
   <strong>1 min read.</strong></div></div><div class="post content-box"><div class="post__header"><img alt="Cover image" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 860 484' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-03f66e9a6f669f40b4ca1ff10ab76be5'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='10'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-03f66e9a6f669f40b4ca1ff10ab76be5)' width='860' height='484' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAkCAIAAAC2bqvFAAAACXBIWXMAAAsSAAALEgHS3X78AAAD6klEQVRYw9XS2W8bRRwH8PmLeOKJJ5544qFACCBB6cElVBUhnIQc5Kqd2F6vj/XazuXYTuqriWmTJlg5gNICXXvt9dpe37trJ3EbktjxUbdpC1KYNlULgjhrqS8jfbSa%2bY3mN9%2bftIBvzCANZOoOpIFkzY40EKvakQYi%2bzakAbo0jTRwe8%2bKNHBrZwpp4OftSaSB1TsTSAM/FMeRBhY2x5AG5gvml8oiVf7lvAjcgqkFotkrjsHvf45Il2B2CRYpHZw84eIJp2By8S%2bKHtECuQTT0cItmCVGAjM5sgW82ZYloH/XjY4cjKW5KnQuCl81tyBcXN8aCpUn2Yrjimi2Z42zOdKRM9qyBkeO9IhT01k97O%2bQHAlYM0YppjPkWApf3vRFysHZ3Pg/joipjGk2p14WP/Pnz/rFc8c7vyycvr3du/nAWbjvTFRnPIJ5Mm2cTBtsWbN/62qqEktXOaYUmMtftmZIicHAWIqQbrNRODw8ZMuMJWV4XrSkCHf0vI9tm2c/mGffP85cpH2BOyM0HFxt1smT5icdjGQCv1aYu/e4Ru9R6WryjwfbyQpXeVRhS4wxgY%2bnjCdGAsaEQQoyQeg5rVgX4ACB3YA2jpkSBKwTCaOFU3rD7d5wmzf87nGuhNtd9KnV7NfFA4%2bvYMFiuqOeujjuEdzFRrHxZ6P2uFZ%2bWDr46yHc/nhnHT4nJRjQxvVS6DlilFX5t1bgAGI9r2CVeFynjes0cQPJqZZ4%2bHs098li7uNf7/YVD7we0ayIaOFdXdygimou8674Pkfv0plqlq8Jgd0gW46uFdexGC4lGFCxOomUrBaLGjbubcEZbty9KWfUsALBo%2b9zX/qFM0vCp01mWOLPruYv5O87mX0HwekvMbiS1SkYzJqe4WtitsZHSjF6l8lUc2K9cH3DPxLRqFn9iakAbCSRnNEOhTEsSjJ7sdqjerbK/75DT2ecQ4wWZwa9TLuPeXueeed4bd7QqVv5zuKBW3gyhs3AGQbDGtjZEJ%2b4vrHClrhkJbNW/MWStA0/rUsB%2bkMa6QZCeB%2bt7goo5Ayhj1s10fHhsL4/hPXR2hF6aIL%2b3E6ftoeasdEfLmS6qZ2JcNmOx/S9QWwgpOkJqjopuYIhVKylKzDSHRyFD0mMBLqDWEt6gvA9vCugllGjHZQSLo7qXbAYxHuDqpOov6UUPQFld1Dz/O6znhQcQwUXcCs9D/iGUrdKRqk7KOyI7EVRJaOUT7/NqTsCzy7K/q9tq2HAxd%2bUSANf3BxFGjh3YwRp4KOf5EgD761dQhp4a2UYaeBN/yDSwBvLA0gDry/2Iw28du07pIFXfb1IA6/M9SDtb7cMizY%2bH0Q1AAAAAElFTkSuQmCC' /%3e%3c/svg%3e" width="860" data-src="/blog/assets/static/celery.07cc2b7.1e7fb99de7f67fa327e67d073f7413d6.png" data-srcset="/blog/assets/static/celery.a67b0b2.1e7fb99de7f67fa327e67d073f7413d6.png 480w, /blog/assets/static/celery.07cc2b7.1e7fb99de7f67fa327e67d073f7413d6.png 860w" data-sizes="(max-width: 860px) 100vw, 860px" class="g-image g-image--lazy g-image--loading"><noscript><img src="/blog/assets/static/celery.07cc2b7.1e7fb99de7f67fa327e67d073f7413d6.png" class="g-image g-image--loaded" width="860" alt="Cover image"></noscript></div><div class="post__content"><p>I guess this a followup to the <a href="https://almadih.github.io/blog/async-distributed-tasks-in-python-with-celery/" target="_blank" rel="nofollow noopener noreferrer">previous post</a>, where i talked about celery and some pref and examples about it, i think this could be a series where i show the problems i faced during the project and how i overcome them.</p>
<h2 id="the-problem"><a href="#the-problem" aria-hidden="true"><span class="icon icon-link"></span></a>The problem</h2>
<p>The project is running in multiple servers with different amount of resources, the mistake i did is running celery with fixed number of threads in all servers this cause smaller servers to hang since the receive huge number of tasks larger thant their resources.</p>
<h2 id="the-solution"><a href="#the-solution" aria-hidden="true"><span class="icon icon-link"></span></a>The solution</h2>
<p>Solution is very simple i came up with an equation to calculate threads number based on amount of CPUs and Ram the server has. </p>
<div class="gridsome-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token comment">#worker.sh</span>
<span class="token assign-left variable">cpus</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>nproc --all<span class="token variable">)</span></span>
<span class="token assign-left variable">ram</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">free</span> -g <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/^Mem:/{print $2}'</span><span class="token variable">)</span></span>
<span class="token assign-left variable">threads</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>cpus<span class="token operator">*</span><span class="token number">15</span> <span class="token operator">+</span> ram<span class="token operator">*</span><span class="token number">15</span><span class="token variable">))</span></span>

celery -A celery_app.tasks worker --loglevel<span class="token operator">=</span>info --pool<span class="token operator">=</span>threads -c <span class="token variable">$threads</span></code></pre></div>
<p>the <code class="language-inline-text">15</code> here is arbitrary number, of course this should be determined carefully based on tasks type and wight.  </p>
</div><div class="post__footer"><div class="post-tags"><a href="/blog/tag/python/" class="post-tags__link"><span>#</span> python
		</a><a href="/blog/tag/celery/" class="post-tags__link"><span>#</span> celery
		</a></div></div></div><div class="post-comments"></div></main><footer class="footer"><span class="footer__copyright">Copyright © 2022.
    </span><span class="footer__links">Powered by <a href="//gridsome.org"> Gridsome </a></span></footer></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"title":"Dynamic number of threads in celery","path":"\u002Fdynamic-number-of-threads-in-celery\u002F","date":"2. August 2022","timeToRead":1,"tags":[{"id":"python","title":"python","path":"\u002Ftag\u002Fpython\u002F"},{"id":"celery","title":"celery","path":"\u002Ftag\u002Fcelery\u002F"}],"description":"I guess this a followup to the previous post, where i talked about celery and some..","content":"\u003Cp\u003EI guess this a followup to the \u003Ca href=\"https:\u002F\u002Falmadih.github.io\u002Fblog\u002Fasync-distributed-tasks-in-python-with-celery\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Eprevious post\u003C\u002Fa\u003E, where i talked about celery and some pref and examples about it, i think this could be a series where i show the problems i faced during the project and how i overcome them.\u003C\u002Fp\u003E\n\u003Ch2 id=\"the-problem\"\u003E\u003Ca href=\"#the-problem\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EThe problem\u003C\u002Fh2\u003E\n\u003Cp\u003EThe project is running in multiple servers with different amount of resources, the mistake i did is running celery with fixed number of threads in all servers this cause smaller servers to hang since the receive huge number of tasks larger thant their resources.\u003C\u002Fp\u003E\n\u003Ch2 id=\"the-solution\"\u003E\u003Ca href=\"#the-solution\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EThe solution\u003C\u002Fh2\u003E\n\u003Cp\u003ESolution is very simple i came up with an equation to calculate threads number based on amount of CPUs and Ram the server has. \u003C\u002Fp\u003E\n\u003Cdiv class=\"gridsome-highlight\" data-language=\"shell\"\u003E\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token comment\"\u003E#worker.sh\u003C\u002Fspan\u003E\n\u003Cspan class=\"token assign-left variable\"\u003Ecpus\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003Enproc --all\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"token assign-left variable\"\u003Eram\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Efree\u003C\u002Fspan\u003E -g \u003Cspan class=\"token operator\"\u003E|\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Eawk\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'\u002F^Mem:\u002F{print $2}'\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"token assign-left variable\"\u003Ethreads\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$((\u003C\u002Fspan\u003Ecpus\u003Cspan class=\"token operator\"\u003E*\u003C\u002Fspan\u003E\u003Cspan class=\"token number\"\u003E15\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E+\u003C\u002Fspan\u003E ram\u003Cspan class=\"token operator\"\u003E*\u003C\u002Fspan\u003E\u003Cspan class=\"token number\"\u003E15\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E))\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\n\ncelery -A celery_app.tasks worker --loglevel\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003Einfo --pool\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003Ethreads -c \u003Cspan class=\"token variable\"\u003E$threads\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n\u003Cp\u003Ethe \u003Ccode class=\"language-inline-text\"\u003E15\u003C\u002Fcode\u003E here is arbitrary number, of course this should be determined carefully based on tasks type and wight.  \u003C\u002Fp\u003E\n","coverImage":{"type":"image","mimeType":"image\u002Fpng","src":"\u002Fblog\u002Fassets\u002Fstatic\u002Fcelery.07cc2b7.1e7fb99de7f67fa327e67d073f7413d6.png","size":{"width":860,"height":484},"sizes":"(max-width: 860px) 100vw, 860px","srcset":["\u002Fblog\u002Fassets\u002Fstatic\u002Fcelery.a67b0b2.1e7fb99de7f67fa327e67d073f7413d6.png 480w","\u002Fblog\u002Fassets\u002Fstatic\u002Fcelery.07cc2b7.1e7fb99de7f67fa327e67d073f7413d6.png 860w"],"dataUri":"data:image\u002Fsvg+xml,%3csvg fill='none' viewBox='0 0 860 484' xmlns='http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg' xmlns:xlink='http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-03f66e9a6f669f40b4ca1ff10ab76be5'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='10'\u002F%3e%3c\u002Ffilter%3e%3c\u002Fdefs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-03f66e9a6f669f40b4ca1ff10ab76be5)' width='860' height='484' xlink:href='data:image\u002Fpng%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAkCAIAAAC2bqvFAAAACXBIWXMAAAsSAAALEgHS3X78AAAD6klEQVRYw9XS2W8bRRwH8PmLeOKJJ5544qFACCBB6cElVBUhnIQc5Kqd2F6vj\u002FXazuXYTuqriWmTJlg5gNICXXvt9dpe37trJ3EbktjxUbdpC1KYNlULgjhrqS8jfbSa%2bY3mN9%2bftIBvzCANZOoOpIFkzY40EKvakQYi%2bzakAbo0jTRwe8%2bKNHBrZwpp4OftSaSB1TsTSAM\u002FFMeRBhY2x5AG5gvml8oiVf7lvAjcgqkFotkrjsHvf45Il2B2CRYpHZw84eIJp2By8S%2bKHtECuQTT0cItmCVGAjM5sgW82ZYloH\u002FXjY4cjKW5KnQuCl81tyBcXN8aCpUn2Yrjimi2Z42zOdKRM9qyBkeO9IhT01k97O%2bQHAlYM0YppjPkWApf3vRFysHZ3Pg\u002FjoipjGk2p14WP\u002FPnz\u002FrFc8c7vyycvr3du\u002FnAWbjvTFRnPIJ5Mm2cTBtsWbN\u002F62qqEktXOaYUmMtftmZIicHAWIqQbrNRODw8ZMuMJWV4XrSkCHf0vI9tm2c\u002FmGffP85cpH2BOyM0HFxt1smT5icdjGQCv1aYu\u002Fe4Ru9R6WryjwfbyQpXeVRhS4wxgY%2bnjCdGAsaEQQoyQeg5rVgX4ACB3YA2jpkSBKwTCaOFU3rD7d5wmzf87nGuhNtd9KnV7NfFA4%2bvYMFiuqOeujjuEdzFRrHxZ6P2uFZ%2bWDr46yHc\u002FnhnHT4nJRjQxvVS6DlilFX5t1bgAGI9r2CVeFynjes0cQPJqZZ4%2bHs098li7uNf7\u002FYVD7we0ayIaOFdXdygimou8674Pkfv0plqlq8Jgd0gW46uFdexGC4lGFCxOomUrBaLGjbubcEZbty9KWfUsALBo%2b9zX\u002FqFM0vCp01mWOLPruYv5O87mX0HwekvMbiS1SkYzJqe4WtitsZHSjF6l8lUc2K9cH3DPxLRqFn9iakAbCSRnNEOhTEsSjJ7sdqjerbK\u002F75DT2ecQ4wWZwa9TLuPeXueeed4bd7QqVv5zuKBW3gyhs3AGQbDGtjZEJ%2b4vrHClrhkJbNW\u002FMWStA0\u002FrUsB%2bkMa6QZCeB%2bt7goo5Ayhj1s10fHhsL4\u002FhPXR2hF6aIL%2b3E6ftoeasdEfLmS6qZ2JcNmOx\u002FS9QWwgpOkJqjopuYIhVKylKzDSHRyFD0mMBLqDWEt6gvA9vCugllGjHZQSLo7qXbAYxHuDqpOov6UUPQFld1Dz\u002FO6znhQcQwUXcCs9D\u002FiGUrdKRqk7KOyI7EVRJaOUT7\u002FNqTsCzy7K\u002Fq9tq2HAxd%2bUSANf3BxFGjh3YwRp4KOf5EgD761dQhp4a2UYaeBN\u002FyDSwBvLA0gDry\u002F2Iw28du07pIFXfb1IA6\u002FM9SDtb7cMizY%2bH0Q1AAAAAElFTkSuQmCC' \u002F%3e%3c\u002Fsvg%3e"}}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/blog/assets/js/app.344265fc.js" defer></script><script src="/blog/assets/js/page--src--templates--post-vue.aca2b486.js" defer></script>
  </body>
</html>