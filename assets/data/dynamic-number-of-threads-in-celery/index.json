{"hash":"33cba4920c19c25c8a4390379f4aca5e62df75b6","data":{"post":{"title":"Dynamic number of threads in celery","path":"/dynamic-number-of-threads-in-celery/","date":"2. August 2022","timeToRead":1,"tags":[{"id":"python","title":"python","path":"/tag/python/"},{"id":"celery","title":"celery","path":"/tag/celery/"}],"description":"I guess this a followup to the previous post, where i talked about celery and some..","content":"<p>I guess this a followup to the <a href=\"https://almadih.github.io/blog/async-distributed-tasks-in-python-with-celery/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">previous post</a>, where i talked about celery and some pref and examples about it, i think this could be a series where i show the problems i faced during the project and how i overcome them.</p>\n<h2 id=\"the-problem\"><a href=\"#the-problem\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>The problem</h2>\n<p>The project is running in multiple servers with different amount of resources, the mistake i did is running celery with fixed number of threads in all servers this cause smaller servers to hang since the receive huge number of tasks larger thant their resources.</p>\n<h2 id=\"the-solution\"><a href=\"#the-solution\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>The solution</h2>\n<p>Solution is very simple i came up with an equation to calculate threads number based on amount of CPUs and Ram the server has. </p>\n<div class=\"gridsome-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\">#worker.sh</span>\n<span class=\"token assign-left variable\">cpus</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>nproc --all<span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">ram</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">free</span> -g <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'/^Mem:/{print $2}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">threads</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span>cpus<span class=\"token operator\">*</span><span class=\"token number\">15</span> <span class=\"token operator\">+</span> ram<span class=\"token operator\">*</span><span class=\"token number\">15</span><span class=\"token variable\">))</span></span>\n\ncelery -A celery_app.tasks worker --loglevel<span class=\"token operator\">=</span>info --pool<span class=\"token operator\">=</span>threads -c <span class=\"token variable\">$threads</span></code></pre></div>\n<p>the <code class=\"language-inline-text\">15</code> here is arbitrary number, of course this should be determined carefully based on tasks type and wight.  </p>\n","coverImage":{"type":"image","mimeType":"image/png","src":"/blog/assets/static/celery.07cc2b7.1e7fb99de7f67fa327e67d073f7413d6.png","size":{"width":860,"height":484},"sizes":"(max-width: 860px) 100vw, 860px","srcset":["/blog/assets/static/celery.a67b0b2.1e7fb99de7f67fa327e67d073f7413d6.png 480w","/blog/assets/static/celery.07cc2b7.1e7fb99de7f67fa327e67d073f7413d6.png 860w"],"dataUri":"data:image/svg+xml,%3csvg fill='none' viewBox='0 0 860 484' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-03f66e9a6f669f40b4ca1ff10ab76be5'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='10'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-03f66e9a6f669f40b4ca1ff10ab76be5)' width='860' height='484' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAkCAIAAAC2bqvFAAAACXBIWXMAAAsSAAALEgHS3X78AAAD6klEQVRYw9XS2W8bRRwH8PmLeOKJJ5544qFACCBB6cElVBUhnIQc5Kqd2F6vj/XazuXYTuqriWmTJlg5gNICXXvt9dpe37trJ3EbktjxUbdpC1KYNlULgjhrqS8jfbSa%2bY3mN9%2bftIBvzCANZOoOpIFkzY40EKvakQYi%2bzakAbo0jTRwe8%2bKNHBrZwpp4OftSaSB1TsTSAM/FMeRBhY2x5AG5gvml8oiVf7lvAjcgqkFotkrjsHvf45Il2B2CRYpHZw84eIJp2By8S%2bKHtECuQTT0cItmCVGAjM5sgW82ZYloH/XjY4cjKW5KnQuCl81tyBcXN8aCpUn2Yrjimi2Z42zOdKRM9qyBkeO9IhT01k97O%2bQHAlYM0YppjPkWApf3vRFysHZ3Pg/joipjGk2p14WP/Pnz/rFc8c7vyycvr3du/nAWbjvTFRnPIJ5Mm2cTBtsWbN/62qqEktXOaYUmMtftmZIicHAWIqQbrNRODw8ZMuMJWV4XrSkCHf0vI9tm2c/mGffP85cpH2BOyM0HFxt1smT5icdjGQCv1aYu/e4Ru9R6WryjwfbyQpXeVRhS4wxgY%2bnjCdGAsaEQQoyQeg5rVgX4ACB3YA2jpkSBKwTCaOFU3rD7d5wmzf87nGuhNtd9KnV7NfFA4%2bvYMFiuqOeujjuEdzFRrHxZ6P2uFZ%2bWDr46yHc/nhnHT4nJRjQxvVS6DlilFX5t1bgAGI9r2CVeFynjes0cQPJqZZ4%2bHs098li7uNf7/YVD7we0ayIaOFdXdygimou8674Pkfv0plqlq8Jgd0gW46uFdexGC4lGFCxOomUrBaLGjbubcEZbty9KWfUsALBo%2b9zX/qFM0vCp01mWOLPruYv5O87mX0HwekvMbiS1SkYzJqe4WtitsZHSjF6l8lUc2K9cH3DPxLRqFn9iakAbCSRnNEOhTEsSjJ7sdqjerbK/75DT2ecQ4wWZwa9TLuPeXueeed4bd7QqVv5zuKBW3gyhs3AGQbDGtjZEJ%2b4vrHClrhkJbNW/MWStA0/rUsB%2bkMa6QZCeB%2bt7goo5Ayhj1s10fHhsL4/hPXR2hF6aIL%2b3E6ftoeasdEfLmS6qZ2JcNmOx/S9QWwgpOkJqjopuYIhVKylKzDSHRyFD0mMBLqDWEt6gvA9vCugllGjHZQSLo7qXbAYxHuDqpOov6UUPQFld1Dz/O6znhQcQwUXcCs9D/iGUrdKRqk7KOyI7EVRJaOUT7/NqTsCzy7K/q9tq2HAxd%2bUSANf3BxFGjh3YwRp4KOf5EgD761dQhp4a2UYaeBN/yDSwBvLA0gDry/2Iw28du07pIFXfb1IA6/M9SDtb7cMizY%2bH0Q1AAAAAElFTkSuQmCC' /%3e%3c/svg%3e"}}},"context":{}}